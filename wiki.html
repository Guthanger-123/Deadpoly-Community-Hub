<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeadPoly Wiki — 3D Viewer + Character Dresser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f18;
      --panel: rgba(20,24,34,.82);
      --panel2: rgba(16,18,26,.78);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --txt:#e7ecff;
      --muted: rgba(231,236,255,.70);
      --accent:#8bb7ff;
      --accent2:#6aa6ff;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(110,170,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(130,90,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* Topbar */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,12,18,.85), rgba(10,12,18,.55));
      backdrop-filter: blur(10px);
    }
    .leftTop{
      display:flex; align-items:center; gap:10px;
      min-width:260px;
    }
    .title{
      font-weight:800;
      letter-spacing:.2px;
      display:flex; gap:10px; align-items:baseline;
    }
    .title small{font-weight:600; color:var(--muted)}
    .centerTop{
      color:var(--muted);
      font-size:13px;
      text-align:center;
      padding:0 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rightTop{
      display:flex; gap:10px; align-items:center;
      min-width:260px;
      justify-content:flex-end;
    }
    a.btn, button.btn{
      appearance:none;
      border:1px solid var(--stroke2);
      color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      padding:8px 12px;
      border-radius:12px;
      text-decoration:none;
      font-weight:650;
      font-size:13px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    a.btn:hover, button.btn:hover{
      border-color: rgba(140,185,255,.35);
      background: linear-gradient(180deg, rgba(140,185,255,.18), rgba(255,255,255,.04));
      transform: translateY(-1px);
    }
    a.btn:active, button.btn:active{transform: translateY(0px);}

    /* Layout */
    .wrap{
      height: calc(100% - 56px);
      display:grid;
      grid-template-columns: 360px 1fr 360px; /* left wiki | stage | right controls */
      gap: 12px;
      padding: 12px;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .panelHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .panelHeader p{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.35;
    }

    .panelBody{
      padding: 12px 14px;
      overflow:auto;
      min-height:0;
    }

    /* Left wiki */
    .wikiGroup{
      border:1px solid var(--stroke);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
      overflow:hidden;
    }
    .wikiGroup summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      user-select:none;
    }
    .wikiGroup summary::-webkit-details-marker{display:none;}
    .wikiGroup .content{
      padding: 0 12px 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .tag{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background: rgba(255,255,255,.04);
      color:var(--txt);
      cursor:pointer;
    }
    .tag:hover{border-color: rgba(140,185,255,.35);}

    /* Stage */
    .viewer{
      position:relative;
      min-height:0;
    }
    #stage{
      position:absolute; inset: 0;
      border-radius: var(--r);
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 40% 0%, rgba(110,170,255,.15), transparent 55%),
        radial-gradient(900px 600px at 70% 30%, rgba(130,90,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));
    }
    .hud{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .chip{
      pointer-events:none;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.35);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:12px;
      backdrop-filter: blur(8px);
    }
    .status{
      pointer-events:none;
      font-size:12px;
      color:rgba(200,255,210,.8);
      background: rgba(0,0,0,.35);
      border:1px solid rgba(120,255,160,.18);
      padding:8px 10px;
      border-radius:12px;
      backdrop-filter: blur(8px);
    }

    /* Right controls */
    .controlsRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-bottom: 12px;
    }
    .mini{
      font-size:12.5px;
      color:var(--muted);
      line-height:1.35;
    }
    .box{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      outline:none;
    }
    select:focus{
      border-color: rgba(140,185,255,.35);
    }

    .hr{
      height:1px;
      background: var(--stroke);
      margin:12px 0;
    }

    /* Mobile */
    @media (max-width: 1100px){
      body{overflow:auto;}
      .wrap{
        height:auto;
        grid-template-columns: 1fr;
      }
      .viewer{height: 60vh;}
      #stage{position:relative; height:60vh;}
      .panel{min-height:unset;}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="leftTop">
      <a class="btn" href="index.html">← Menu</a>
      <div class="title">
        <span>Wiki</span>
        <small>3D Viewer</small>
      </div>
    </div>

    <div class="centerTop">Drag to rotate • Scroll to zoom • Right-drag to pan</div>

    <div class="rightTop">
      <a class="btn" href="tips.html">Tips</a>
      <a class="btn" href="maps.html">Maps</a>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: WIKI CATEGORIES -->
    <section class="panel">
      <div class="panelHeader">
        <h2>Wiki Categories</h2>
        <p>Use this left side as your “mini wiki”. Add entries anytime.</p>
      </div>
      <div class="panelBody">
        <details class="wikiGroup" open>
          <summary>Getting Started <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Basic hub notes, community tips, and quick links.
            <div class="tagRow">
              <div class="tag" onclick="alert('Add a real link here later')">Official</div>
              <div class="tag" onclick="alert('Add a real link here later')">Patch Notes</div>
              <div class="tag" onclick="alert('Add a real link here later')">FAQ</div>
            </div>
          </div>
        </details>

        <details class="wikiGroup">
          <summary>Items <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Add item pages here (weapons, armor, tools, etc). You can also put a 3D showcase on the right.
          </div>
        </details>

        <details class="wikiGroup">
          <summary>Locations <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Add location notes, loot routes, bunker guides, safe zones, etc.
          </div>
        </details>

        <details class="wikiGroup">
          <summary>Behind the Scenes (Dev) <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Put internal notes here (coordinates, POI naming rules, etc).
            <div style="margin-top:10px;" class="mini">
              Tip: If you want a “hidden” dev panel later, we can add a keybind (ex: Ctrl+Shift+D) and a simple passcode gate.
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- CENTER: 3D STAGE -->
    <section class="panel viewer">
      <div id="stage"></div>
      <div class="hud">
        <div class="chip" id="loadedOut">Loaded: (none)</div>
        <div class="status" id="statusOut">Status: Ready.</div>
      </div>
    </section>

    <!-- RIGHT: CONTROLS / CHARACTER DRESSER -->
    <section class="panel">
      <div class="panelHeader">
        <h2>Model Showcase / Character Dresser</h2>
        <p>Loads FBX from <b>assets/models/</b> and base textures from <b>assets/texture/</b>.</p>
      </div>
      <div class="panelBody">

        <div class="controlsRow">
          <button class="btn" id="btnLoadBase">Load Base Model</button>
          <button class="btn" id="btnReset">Reset View</button>
          <button class="btn" id="btnApplyTex">Apply Base Textures</button>
          <button class="btn" id="btnClear">Clear Scene</button>
        </div>

        <div class="box">
          <div class="mini">
            If you see <b>nothing</b> after loading, it’s usually one of:
            <ul style="margin:8px 0 0 18px; color:var(--muted);">
              <li>bad path / filename mismatch (GitHub Pages is case-sensitive)</li>
              <li>model is dark (hit <b>Apply Base Textures</b> and we also light it)</li>
              <li>camera framing (this page auto-frames after load)</li>
            </ul>
          </div>
          <div class="hr"></div>
          <div class="mini"><b>Base FBX path used:</b><br><span id="basePathOut" style="color:var(--accent)"></span></div>
        </div>

        <div class="hr"></div>

        <div class="box">
          <div style="font-weight:900; margin-bottom:8px;">Character Parts</div>
          <div class="mini" style="margin-bottom:10px;">Pick a part to “equip” into that slot.</div>

          <div style="display:grid; gap:10px;">
            <div>
              <label>Head</label>
              <select id="selHead"></select>
            </div>
            <div>
              <label>Hair</label>
              <select id="selHair"></select>
            </div>
            <div>
              <label>Face / Mask</label>
              <select id="selFace"></select>
            </div>
            <div>
              <label>Torso</label>
              <select id="selTorso"></select>
            </div>
            <div>
              <label>Arms (Upper / Lower)</label>
              <select id="selArms"></select>
            </div>
            <div>
              <label>Hands</label>
              <select id="selHands"></select>
            </div>
            <div>
              <label>Hips</label>
              <select id="selHips"></select>
            </div>
            <div>
              <label>Legs / Knees</label>
              <select id="selLegs"></select>
            </div>
            <div>
              <label>Feet</label>
              <select id="selFeet"></select>
            </div>
            <div>
              <label>Extras / Other</label>
              <select id="selExtras"></select>
            </div>
          </div>

          <div class="hr"></div>
          <div class="mini">
            <b>How to add/remove parts:</b><br>
            1) Upload the FBX into <code>assets/models/</code><br>
            2) Add its filename into the <code>PART_FILES</code> list in this file<br>
            3) Refresh — it will auto-sort into slots by the code in the name
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- Three.js + FBXLoader (MODULE) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { FBXLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/FBXLoader.js";

    /* -------------------- CONFIG -------------------- */
    const BASE_FBX = "assets/models/SK_BaseModel.fbx";

    // Your texture folder is named: assets/texture/
    const TEX = {
      color:      "assets/texture/T_ColorMap.png",
      emissive:   "assets/texture/T_EmissionMap.png",
      opacity:    "assets/texture/T_OpacityMap.png",
      reflection: "assets/texture/T_ReflectionMap.png",
      smoothness: "assets/texture/T_SmoothnessMap.png"
    };

    // Put your FBX part filenames here (must exist in assets/models/)
    // NOTE: GitHub Pages is CASE-SENSITIVE.
    const PART_FILES = [
      // Base examples
      "SK_BaseModel.fbx",
      "SK_HORR_VILN_01_22AHED_HU01.fbx",

      // Fantasy knight (examples from your list)
      "SK_FANT_KNGT_17_10TORS_HU01.fbx",
      "SK_FANT_KNGT_17_11AUPL_HU01.fbx",
      "SK_FANT_KNGT_17_12AUPR_HU01.fbx",
      "SK_FANT_KNGT_17_13ALWL_HU01.fbx",
      "SK_FANT_KNGT_17_14ALWR_HU01.fbx",
      "SK_FANT_KNGT_17_15HNDL_HU01.fbx",
      "SK_FANT_KNGT_17_16HNDR_HU01.fbx",
      "SK_FANT_KNGT_17_17HIPS_HU01.fbx",
      "SK_FANT_KNGT_17_18LEGL_HU01.fbx",
      "SK_FANT_KNGT_17_19LEGR_HU01.fbx",
      "SK_FANT_KNGT_17_20FOTL_HU01.fbx",
      "SK_FANT_KNGT_17_21FOTR_HU01.fbx",
      "SK_FANT_KNGT_17_22AHED_HU01.fbx",
      "SK_FANT_KNGT_17_23AFAC_HU01.fbx",
      "SK_FANT_KNGT_17_24ABAC_HU01.fbx",
      "SK_FANT_KNGT_17_25AHPF_HU01.fbx",
      "SK_FANT_KNGT_17_26AHPB_HU01.fbx",
      "SK_FANT_KNGT_17_27AHPL_HU01.fbx",
      "SK_FANT_KNGT_17_28AHPR_HU01.fbx",
      "SK_FANT_KNGT_17_29ASHL_HU01.fbx",
      "SK_FANT_KNGT_17_30ASHR_HU01.fbx",
      "SK_FANT_KNGT_17_31AEBL_HU01.fbx",
      "SK_FANT_KNGT_17_32AEBR_HU01.fbx",
      "SK_FANT_KNGT_17_33AKNL_HU01.fbx",
      "SK_FANT_KNGT_17_34AKNR_HU01.fbx",

      // Sci-fi civl 09 (examples)
      "SK_SCFI_CIVL_09_02HAIR_HU01.fbx",
      "SK_SCFI_CIVL_09_10TORS_HU01.fbx",
      "SK_SCFI_CIVL_09_11AUPL_HU01.fbx",
      "SK_SCFI_CIVL_09_12AUPR_HU01.fbx",
      "SK_SCFI_CIVL_09_13ALWL_HU01.fbx",
      "SK_SCFI_CIVL_09_14ALWR_HU01.fbx",
      "SK_SCFI_CIVL_09_15HNDL_HU01.fbx",
      "SK_SCFI_CIVL_09_16HNDR_HU01.fbx",
      "SK_SCFI_CIVL_09_17HIPS_HU01.fbx",
      "SK_SCFI_CIVL_09_18LEGL_HU01.fbx",
      "SK_SCFI_CIVL_09_19LEGR_HU01.fbx",
      "SK_SCFI_CIVL_09_20FOTL_HU01.fbx",
      "SK_SCFI_CIVL_09_21FOTR_HU01.fbx",
      "SK_SCFI_CIVL_09_22AHED_HU01.fbx",
      "SK_SCFI_CIVL_09_23AFAC_HU01.fbx",
      "SK_SCFI_CIVL_09_24ABAC_HU01.fbx",
      "SK_SCFI_CIVL_09_25AHPF_HU01.fbx",
      "SK_SCFI_CIVL_09_26AHPB_HU01.fbx",
      "SK_SCFI_CIVL_09_27AHPL_HU01.fbx",
      "SK_SCFI_CIVL_09_28AHPR_HU01.fbx",
      "SK_SCFI_CIVL_09_29ASHL_HU01.fbx",
      "SK_SCFI_CIVL_09_30ASHR_HU01.fbx",
      "SK_SCFI_CIVL_09_31AEBL_HU01.fbx",
      "SK_SCFI_CIVL_09_32AEBR_HU01.fbx",
      "SK_SCFI_CIVL_09_33AKNL_HU01.fbx",
      "SK_SCFI_CIVL_09_34AKNR_HU01.fbx",

      // Sci-fi civl 10 (examples)
      "SK_SCFI_CIVL_10_22AHED_HU01.fbx",
      "SK_SCFI_CIVL_10_26AHPB_HU01.fbx",
      "SK_SCFI_CIVL_10_27AHPL_HU01.fbx",
      "SK_SCFI_CIVL_10_28AHPR_HU01.fbx",
      "SK_SCFI_CIVL_10_29ASHL_HU01.fbx",
      "SK_SCFI_CIVL_10_30ASHR_HU01.fbx"
    ];

    /* -------------------- UI refs -------------------- */
    const stage = document.getElementById("stage");
    const loadedOut = document.getElementById("loadedOut");
    const statusOut = document.getElementById("statusOut");
    const basePathOut = document.getElementById("basePathOut");
    basePathOut.textContent = BASE_FBX;

    const btnLoadBase = document.getElementById("btnLoadBase");
    const btnReset = document.getElementById("btnReset");
    const btnApplyTex = document.getElementById("btnApplyTex");
    const btnClear = document.getElementById("btnClear");

    const selects = {
      head:   document.getElementById("selHead"),
      hair:   document.getElementById("selHair"),
      face:   document.getElementById("selFace"),
      torso:  document.getElementById("selTorso"),
      arms:   document.getElementById("selArms"),
      hands:  document.getElementById("selHands"),
      hips:   document.getElementById("selHips"),
      legs:   document.getElementById("selLegs"),
      feet:   document.getElementById("selFeet"),
      extras: document.getElementById("selExtras")
    };

    function setStatus(msg, ok=true){
      statusOut.textContent = "Status: " + msg;
      statusOut.style.borderColor = ok ? "rgba(120,255,160,.18)" : "rgba(255,120,120,.22)";
      statusOut.style.color = ok ? "rgba(200,255,210,.85)" : "rgba(255,200,200,.85)";
    }

    /* -------------------- Three setup -------------------- */
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(45, 1, 0.01, 5000);
    camera.position.set(0, 1.4, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 1.1, 0);

    // Lights (this fixes the “black silhouette” look)
    const hemi = new THREE.HemisphereLight(0xcfe3ff, 0x101018, 1.05);
    scene.add(hemi);

    const key = new THREE.DirectionalLight(0xffffff, 1.25);
    key.position.set(2.5, 4.5, 3.0);
    key.castShadow = false;
    scene.add(key);

    const fill = new THREE.DirectionalLight(0x9bbcff, 0.55);
    fill.position.set(-3.0, 1.8, -2.5);
    scene.add(fill);

    const rim = new THREE.DirectionalLight(0xffffff, 0.35);
    rim.position.set(0, 3.5, -4.0);
    scene.add(rim);

    // Subtle ground reference
    const grid = new THREE.GridHelper(10, 20, 0x334455, 0x223344);
    grid.material.transparent = true;
    grid.material.opacity = 0.18;
    scene.add(grid);

    // Where models go
    const root = new THREE.Group();
    scene.add(root);

    // Keep track of equipped slot meshes
    const slotObjects = new Map(); // slotName -> Object3D
    let baseObject = null;

    function resize(){
      const w = stage.clientWidth;
      const h = stage.clientHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    /* -------------------- Helpers -------------------- */
    const fbxLoader = new FBXLoader();
    const texLoader = new THREE.TextureLoader();

    function clearScene(){
      // remove all slot objects + base
      for (const [slot,obj] of slotObjects){
        root.remove(obj);
      }
      slotObjects.clear();

      if (baseObject){
        root.remove(baseObject);
        baseObject = null;
      }
      loadedOut.textContent = "Loaded: (none)";
      setStatus("Cleared.");
    }

    function computeBox(obj){
      const box = new THREE.Box3().setFromObject(obj);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      return { box, size, center };
    }

    function frameObject(obj){
      const { size, center } = computeBox(obj);
      const maxDim = Math.max(size.x, size.y, size.z);
      const fitDist = maxDim / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov * 0.5)));
      const dist = fitDist * 1.35;

      controls.target.copy(center);
      camera.position.set(center.x + dist*0.35, center.y + dist*0.20, center.z + dist);
      camera.near = Math.max(0.01, maxDim / 500);
      camera.far = Math.max(1000, maxDim * 50);
      camera.updateProjectionMatrix();
      controls.update();
    }

    function normalizeMaterials(obj){
      obj.traverse(child=>{
        if (child.isMesh){
          child.castShadow = false;
          child.receiveShadow = false;

          // If FBX gives MeshPhongMaterial or similar, convert to Standard for better PBR-ish look
          const old = child.material;
          const mats = Array.isArray(old) ? old : [old];

          const newMats = mats.map(m=>{
            const nm = new THREE.MeshStandardMaterial({
              color: (m && m.color) ? m.color.clone() : new THREE.Color(0xffffff),
              roughness: 0.9,
              metalness: 0.05
            });
            return nm;
          });

          child.material = Array.isArray(old) ? newMats : newMats[0];
        }
      });
    }

    async function applyBaseTexturesTo(obj){
      setStatus("Loading textures...");
      const tColor = await texLoader.loadAsync(TEX.color);
      tColor.colorSpace = THREE.SRGBColorSpace;

      // These are “best guess” since your maps aren’t named as standard PBR.
      // You can tweak later.
      let tEmissive=null, tOpacity=null, tRough=null, tMetal=null;

      try { tEmissive = await texLoader.loadAsync(TEX.emissive); } catch {}
      try { tOpacity  = await texLoader.loadAsync(TEX.opacity); } catch {}
      try { tMetal    = await texLoader.loadAsync(TEX.reflection); } catch {}
      try { tRough    = await texLoader.loadAsync(TEX.smoothness); } catch {}

      if (tEmissive) tEmissive.colorSpace = THREE.SRGBColorSpace;

      obj.traverse(child=>{
        if (!child.isMesh) return;
        const mats = Array.isArray(child.material) ? child.material : [child.material];
        mats.forEach(mat=>{
          mat.map = tColor;

          if (tEmissive){
            mat.emissive = new THREE.Color(0xffffff);
            mat.emissiveMap = tEmissive;
            mat.emissiveIntensity = 0.25;
          }

          if (tOpacity){
            mat.alphaMap = tOpacity;
            mat.transparent = true;
            mat.opacity = 1.0;
          }

          // reflection map as “metalness map” (approx)
          if (tMetal){
            mat.metalness = 0.15;
            mat.metalnessMap = tMetal;
          }

          // smoothness map inverted-ish to roughness (approx)
          if (tRough){
            mat.roughness = 0.85;
            mat.roughnessMap = tRough;
          }

          mat.needsUpdate = true;
        });
      });

      setStatus("Textures applied.");
    }

    function loadFBX(path){
      return new Promise((resolve,reject)=>{
        fbxLoader.load(
          path,
          (obj)=>resolve(obj),
          (xhr)=>{ /* progress optional */ },
          (err)=>reject(err)
        );
      });
    }

    /* -------------------- Slot logic (auto-sort filenames) -------------------- */
    function slotFromFilename(fn){
      // Looks at chunk like: _22AHED_ , _02HAIR_ , _10TORS_ etc
      const u = fn.toUpperCase();

      if (u.includes("HAIR")) return "hair";
      if (u.includes("AHED")) return "head";
      if (u.includes("AFAC") || u.includes("ABAC")) return "face";
      if (u.includes("TORS")) return "torso";
      if (u.includes("AUPL") || u.includes("AUPR") || u.includes("ALWL") || u.includes("ALWR")) return "arms";
      if (u.includes("HNDL") || u.includes("HNDR")) return "hands";
      if (u.includes("HIPS")) return "hips";
      if (u.includes("LEGL") || u.includes("LEGR") || u.includes("AKNL") || u.includes("AKNR")) return "legs";
      if (u.includes("FOTL") || u.includes("FOTR")) return "feet";

      // Helm pieces etc
      if (u.includes("AHP") || u.includes("AEB") || u.includes("ASH") || u.includes("AHPB") || u.includes("AHPF")) return "extras";

      return "extras";
    }

    function buildPartLists(){
      const buckets = {
        head:[], hair:[], face:[], torso:[], arms:[], hands:[], hips:[], legs:[], feet:[], extras:[]
      };

      PART_FILES.forEach(fn=>{
        if (!fn.toLowerCase().endsWith(".fbx")) return;
        if (fn === "SK_BaseModel.fbx") return; // keep base out of parts lists
        const slot = slotFromFilename(fn);
        buckets[slot].push(fn);
      });

      // sort for nicer dropdowns
      Object.keys(buckets).forEach(k=>buckets[k].sort());
      return buckets;
    }

    function fillSelect(selectEl, files){
      selectEl.innerHTML = "";
      // first option = none
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "(none)";
      selectEl.appendChild(opt0);

      files.forEach(fn=>{
        const opt = document.createElement("option");
        opt.value = fn;
        opt.textContent = fn.replace(".fbx",""); // display
        selectEl.appendChild(opt);
      });
    }

    function initDropdowns(){
      const lists = buildPartLists();
      fillSelect(selects.head, lists.head);
      fillSelect(selects.hair, lists.hair);
      fillSelect(selects.face, lists.face);
      fillSelect(selects.torso, lists.torso);
      fillSelect(selects.arms, lists.arms);
      fillSelect(selects.hands, lists.hands);
      fillSelect(selects.hips, lists.hips);
      fillSelect(selects.legs, lists.legs);
      fillSelect(selects.feet, lists.feet);
      fillSelect(selects.extras, lists.extras);
    }

    initDropdowns();

    async function equip(slot, filename){
      // remove existing in that slot
      if (slotObjects.has(slot)){
        root.remove(slotObjects.get(slot));
        slotObjects.delete(slot);
      }
      if (!filename){
        setStatus(`Removed ${slot}.`);
        return;
      }

      const path = "assets/models/" + filename;
      setStatus(`Loading ${slot}...`);
      try{
        const obj = await loadFBX(path);
        normalizeMaterials(obj);

        // IMPORTANT:
        // These parts will only line up automatically if:
        // - they share the same skeleton/origin OR are already positioned to match base in the FBX files.
        // If they don't line up, that's an asset/origin issue (not a web issue).
        root.add(obj);
        slotObjects.set(slot, obj);

        loadedOut.textContent = `Loaded: ${filename}`;
        setStatus(`Equipped ${slot}.`);

        // Frame the full character (base + parts) if base exists, else frame the part.
        frameObject(baseObject || obj);

      }catch(e){
        console.error(e);
        setStatus(`Failed to load ${filename} (check path/case).`, false);
      }
    }

    // Hook up selects
    selects.head.addEventListener("change", e=>equip("head", e.target.value));
    selects.hair.addEventListener("change", e=>equip("hair", e.target.value));
    selects.face.addEventListener("change", e=>equip("face", e.target.value));
    selects.torso.addEventListener("change", e=>equip("torso", e.target.value));
    selects.arms.addEventListener("change", e=>equip("arms", e.target.value));
    selects.hands.addEventListener("change", e=>equip("hands", e.target.value));
    selects.hips.addEventListener("change", e=>equip("hips", e.target.value));
    selects.legs.addEventListener("change", e=>equip("legs", e.target.value));
    selects.feet.addEventListener("change", e=>equip("feet", e.target.value));
    selects.extras.addEventListener("change", e=>equip("extras", e.target.value));

    /* -------------------- Buttons -------------------- */
    btnClear.addEventListener("click", clearScene);

    btnReset.addEventListener("click", ()=>{
      const targetObj = baseObject || (slotObjects.size ? [...slotObjects.values()][0] : null);
      if (targetObj) frameObject(targetObj);
      else setStatus("Nothing to frame.");
    });

    btnLoadBase.addEventListener("click", async ()=>{
      setStatus("Loading base...");
      try{
        // if base already loaded, re-frame it
        if (baseObject){
          frameObject(baseObject);
          setStatus("Base already loaded.");
          return;
        }

        const obj = await loadFBX(BASE_FBX);
        normalizeMaterials(obj);
        baseObject = obj;
        root.add(obj);

        loadedOut.textContent = "Loaded: SK_BaseModel.fbx";
        setStatus("Base loaded.");
        frameObject(obj);

      }catch(e){
        console.error(e);
        setStatus("Failed to load base (check BASE_FBX path/case).", false);
      }
    });

    btnApplyTex.addEventListener("click", async ()=>{
      const target = baseObject;
      if (!target){
        setStatus("Load base first, then apply textures.", false);
        return;
      }
      try{
        await applyBaseTexturesTo(target);
        frameObject(target);
      }catch(e){
        console.error(e);
        setStatus("Texture apply failed (check /assets/texture/ paths).", false);
      }
    });

    setStatus("Ready.");
  </script>
</body>
</html>
