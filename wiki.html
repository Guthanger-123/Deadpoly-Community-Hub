<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeadPoly Wiki — Model Showcase + Character Dresser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f18;
      --panel: rgba(20,24,34,.82);
      --panel2: rgba(16,18,26,.78);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --txt:#e7ecff;
      --muted: rgba(231,236,255,.70);
      --accent:#8bb7ff;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 16px;
      --r2: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(110,170,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(130,90,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* Topbar */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,12,18,.85), rgba(10,12,18,.55));
      backdrop-filter: blur(10px);
    }
    .leftTop{display:flex; align-items:center; gap:10px; min-width:260px;}
    .title{
      font-weight:850;
      letter-spacing:.2px;
      display:flex; gap:10px; align-items:baseline;
    }
    .title small{font-weight:650; color:var(--muted)}
    .centerTop{
      color:var(--muted);
      font-size:13px;
      text-align:center;
      padding:0 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rightTop{display:flex; gap:10px; align-items:center; min-width:260px; justify-content:flex-end;}
    a.btn, button.btn{
      appearance:none;
      border:1px solid var(--stroke2);
      color:var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      padding:8px 12px;
      border-radius:12px;
      text-decoration:none;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    a.btn:hover, button.btn:hover{
      border-color: rgba(140,185,255,.35);
      background: linear-gradient(180deg, rgba(140,185,255,.18), rgba(255,255,255,.04));
      transform: translateY(-1px);
    }
    a.btn:active, button.btn:active{transform: translateY(0px);}

    /* Layout: LEFT wiki + CENTER stack (small viewer + notes) + RIGHT dresser */
    .wrap{
      height: calc(100% - 56px);
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      gap: 12px;
      padding: 12px;
      min-height:0;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .panelHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .panelHeader h2{
      margin:0;
      font-size:16px;
      font-weight:850;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .panelHeader p{
      margin:6px 0 0;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.35;
    }
    .panelBody{
      padding: 12px 14px;
      overflow:auto;
      min-height:0;
    }

    /* LEFT: Wiki categories */
    .wikiGroup{
      border:1px solid var(--stroke);
      border-radius:var(--r2);
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
      overflow:hidden;
    }
    .wikiGroup summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:850;
      user-select:none;
    }
    .wikiGroup summary::-webkit-details-marker{display:none;}
    .wikiGroup .content{
      padding: 0 12px 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .tagRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .tag{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background: rgba(255,255,255,.04);
      color:var(--txt);
      cursor:pointer;
    }
    .tag:hover{border-color: rgba(140,185,255,.35);}

    /* CENTER column stack */
    .centerCol{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    /* Smaller viewer panel (not 60%+ of entire page) */
    .viewerPanel{
      flex: 0 0 46%;   /* <- keeps it under ~half the height */
      min-height: 320px;
      position:relative;
    }
    #stage{
      position:absolute; inset: 0;
      border-radius: var(--r);
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 40% 0%, rgba(110,170,255,.15), transparent 55%),
        radial-gradient(900px 600px at 70% 30%, rgba(130,90,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));
    }

    .hud{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .chip{
      pointer-events:none;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.35);
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:12px;
      backdrop-filter: blur(8px);
    }
    .status{
      pointer-events:none;
      font-size:12px;
      color:rgba(200,255,210,.8);
      background: rgba(0,0,0,.35);
      border:1px solid rgba(120,255,160,.18);
      padding:8px 10px;
      border-radius:12px;
      backdrop-filter: blur(8px);
    }

    /* WIP badge (auto hides on successful load) */
    .wip{
      position:absolute;
      top:12px;
      left:12px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
    }
    .wipDot{
      width:10px;height:10px;border-radius:99px;
      background: #ffcc66;
      box-shadow: 0 0 18px rgba(255,204,102,.45);
    }
    .wipTitle{font-weight:900; letter-spacing:.2px}
    .wipSub{color:var(--muted); font-size:12px}
    .wipHidden{display:none;}

    /* Viewer top-right mini buttons */
    .viewerActions{
      position:absolute;
      top:12px;
      right:12px;
      display:flex;
      gap:10px;
      z-index:10;
    }
    .viewerActions button{
      pointer-events:auto;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.25);
      color:var(--txt);
      cursor:pointer;
      font-weight:800;
    }
    .viewerActions button:hover{
      border-color: rgba(140,185,255,.35);
      background: rgba(140,185,255,.12);
    }

    /* Center “notes” panel */
    .noteCard{
      flex: 1 1 auto;
      min-height:0;
    }
    .mini{
      font-size:12.5px;
      color:var(--muted);
      line-height:1.4;
    }
    .hr{height:1px;background: var(--stroke); margin:12px 0;}
    code{
      background: rgba(255,255,255,.08);
      padding:2px 6px;
      border-radius:6px;
    }

    /* RIGHT controls / dresser */
    .controlsRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-bottom: 12px;
    }
    .box{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: var(--r2);
      padding: 12px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      outline:none;
    }
    select:focus{border-color: rgba(140,185,255,.35);}

    /* Fullscreen overlay (Showcase mode) */
    .fsOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.68);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .fsOverlay.show{display:flex;}
    .fsFrame{
      width: min(1400px, 96vw);
      height: min(860px, 92vh);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,14,.55);
      position:relative;
      overflow:hidden;
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
    }
    #stageFS{
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 700px at 40% 0%, rgba(110,170,255,.15), transparent 55%),
        radial-gradient(900px 600px at 70% 30%, rgba(130,90,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));
    }
    .fsTop{
      position:absolute;
      top:12px; left:12px; right:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .fsTop .left, .fsTop .right{display:flex; gap:10px; align-items:center;}
    .fsTop .left .chip, .fsTop .right .chip{pointer-events:none;}
    .fsTop button{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color:var(--txt);
      border-radius:12px;
      padding:8px 10px;
      font-weight:850;
      cursor:pointer;
    }
    .fsTop button:hover{background: rgba(140,185,255,.12); border-color: rgba(140,185,255,.32);}

    /* Mobile */
    @media (max-width: 1100px){
      body{overflow:auto;}
      .wrap{height:auto; grid-template-columns: 1fr;}
      .centerCol{height:auto;}
      .viewerPanel{height: 52vh; flex: 0 0 auto;}
      #stage{position:relative; height:52vh;}
      .panel{min-height:unset;}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="leftTop">
      <a class="btn" href="index.html">← Menu</a>
      <div class="title">
        <span>Wiki</span>
        <small>Model Showcase</small>
      </div>
    </div>

    <div class="centerTop">Drag to rotate • Scroll to zoom • Right-drag to pan</div>

    <div class="rightTop">
      <a class="btn" href="tips.html">Tips</a>
      <a class="btn" href="maps.html">Maps</a>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: WIKI CATEGORIES -->
    <section class="panel">
      <div class="panelHeader">
        <h2>Wiki Categories</h2>
        <p>Left side is your “mini wiki”. Add entries any time.</p>
      </div>
      <div class="panelBody">
        <details class="wikiGroup" open>
          <summary>Getting Started <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Basic hub notes, community tips, and quick links.
            <div class="tagRow">
              <div class="tag" onclick="alert('Put a real link later')">Official</div>
              <div class="tag" onclick="alert('Put a real link later')">Patch Notes</div>
              <div class="tag" onclick="alert('Put a real link later')">FAQ</div>
            </div>
          </div>
        </details>

        <details class="wikiGroup">
          <summary>Items <span style="color:var(--muted)">+</span></summary>
          <div class="content">Weapons, armor, tools. Pair with 3D showcase on the right.</div>
        </details>

        <details class="wikiGroup">
          <summary>Locations <span style="color:var(--muted)">+</span></summary>
          <div class="content">Loot routes, bunker notes, safe zones, POIs.</div>
        </details>

        <details class="wikiGroup">
          <summary>Guides <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Put “how-to” stuff here (beginner route, bunker clear, economy, etc).
          </div>
        </details>

        <details class="wikiGroup">
          <summary>Dev Notes <span style="color:var(--muted)">+</span></summary>
          <div class="content">
            Internal notes (coords, naming rules, spawn logic notes).
          </div>
        </details>
      </div>
    </section>

    <!-- CENTER: smaller stage + notes -->
    <div class="centerCol">
      <section class="panel viewerPanel">
        <div id="stage"></div>

        <div class="viewerActions">
          <button id="btnFullscreen" title="Fullscreen Showcase">Fullscreen</button>
        </div>

        <div class="wip" id="wipBadge">
          <div class="wipDot"></div>
          <div>
            <div class="wipTitle">WIP</div>
            <div class="wipSub">3D loads are being wired up.</div>
          </div>
        </div>

        <div class="hud">
          <div class="chip" id="loadedOut">Loaded: (none)</div>
          <div class="status" id="statusOut">Status: Ready.</div>
        </div>
      </section>

      <section class="panel noteCard">
        <div class="panelHeader">
          <h2>
            Quick Notes
            <span style="color:var(--muted); font-size:12px; font-weight:800;">(you can delete this later)</span>
          </h2>
          <p>Common reasons you see “blank” even when Three.js is working.</p>
        </div>
        <div class="panelBody">
          <div class="mini">
            <b>If the FBX loads but looks black:</b> you need lighting + materials. This page includes lighting and also converts materials to <code>MeshStandardMaterial</code>.
          </div>
          <div class="hr"></div>
          <div class="mini">
            <b>If nothing appears and no console error:</b> most often it’s a path/case mismatch or Git LFS pointer files. GitHub Pages is case-sensitive.
          </div>
          <div class="hr"></div>
          <div class="mini">
            Base textures expected in: <code>assets/texture/</code><br/>
            FBX expected in: <code>assets/models/</code>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT: CONTROLS / CHARACTER DRESSER -->
    <section class="panel">
      <div class="panelHeader">
        <h2>Model Showcase / Character Dresser</h2>
        <p>Loads FBX from <b>assets/models/</b> and textures from <b>assets/texture/</b>.</p>
      </div>

      <div class="panelBody">
        <div class="controlsRow">
          <button class="btn" id="btnLoadBase">Load Base Model</button>
          <button class="btn" id="btnReset">Reset View</button>
          <button class="btn" id="btnApplyTex">Apply Base Textures</button>
          <button class="btn" id="btnClear">Clear Scene</button>
        </div>

        <div class="box">
          <div class="mini">
            <b>Base FBX path used:</b><br>
            <span id="basePathOut" style="color:var(--accent)"></span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">Character Parts</div>
          <div class="mini" style="margin-bottom:10px;">Pick a part to equip into that slot.</div>

          <div style="display:grid; gap:10px;">
            <div><label>Head</label><select id="selHead"></select></div>
            <div><label>Hair</label><select id="selHair"></select></div>
            <div><label>Face / Mask</label><select id="selFace"></select></div>
            <div><label>Torso</label><select id="selTorso"></select></div>
            <div><label>Arms (Upper / Lower)</label><select id="selArms"></select></div>
            <div><label>Hands</label><select id="selHands"></select></div>
            <div><label>Hips</label><select id="selHips"></select></div>
            <div><label>Legs / Knees</label><select id="selLegs"></select></div>
            <div><label>Feet</label><select id="selFeet"></select></div>
            <div><label>Extras / Other</label><select id="selExtras"></select></div>
          </div>

          <div class="hr"></div>
          <div class="mini">
            <b>Add / remove parts:</b><br>
            1) Upload FBX into <code>assets/models/</code><br>
            2) Add filename to <code>PART_FILES</code> below<br>
            3) Refresh — the dropdowns auto-sort by name codes (AHED/HAIR/TORS/etc)
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Fullscreen overlay -->
  <div class="fsOverlay" id="fsOverlay">
    <div class="fsFrame">
      <div id="stageFS"></div>

      <div class="fsTop">
        <div class="left">
          <div class="chip" id="loadedOutFS">Loaded: (none)</div>
          <div class="chip" style="color:var(--muted)">Showcase Mode</div>
        </div>
        <div class="right">
          <button id="btnCloseFS">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js + FBXLoader (MODULE) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { FBXLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/FBXLoader.js";

    /* -------------------- CONFIG -------------------- */
    const BASE_FBX = "assets/models/SK_BaseModel.fbx";

    const TEX = {
      color:      "assets/texture/T_ColorMap.png",
      emissive:   "assets/texture/T_EmissionMap.png",
      opacity:    "assets/texture/T_OpacityMap.png",
      reflection: "assets/texture/T_ReflectionMap.png",
      smoothness: "assets/texture/T_SmoothnessMap.png"
    };

    // Put your FBX part filenames here (must exist in assets/models/)
    const PART_FILES = [
      // Horror / head example
      "SK_HORR_VILN_01_22AHED_HU01.fbx",

      // Fantasy knight set (from your list)
      "SK_FANT_KNGT_17_10TORS_HU01.fbx",
      "SK_FANT_KNGT_17_11AUPL_HU01.fbx",
      "SK_FANT_KNGT_17_12AUPR_HU01.fbx",
      "SK_FANT_KNGT_17_13ALWL_HU01.fbx",
      "SK_FANT_KNGT_17_14ALWR_HU01.fbx",
      "SK_FANT_KNGT_17_15HNDL_HU01.fbx",
      "SK_FANT_KNGT_17_16HNDR_HU01.fbx",
      "SK_FANT_KNGT_17_17HIPS_HU01.fbx",
      "SK_FANT_KNGT_17_18LEGL_HU01.fbx",
      "SK_FANT_KNGT_17_19LEGR_HU01.fbx",
      "SK_FANT_KNGT_17_20FOTL_HU01.fbx",
      "SK_FANT_KNGT_17_21FOTR_HU01.fbx",
      "SK_FANT_KNGT_17_22AHED_HU01.fbx",
      "SK_FANT_KNGT_17_23AFAC_HU01.fbx",
      "SK_FANT_KNGT_17_24ABAC_HU01.fbx",
      "SK_FANT_KNGT_17_25AHPF_HU01.fbx",
      "SK_FANT_KNGT_17_26AHPB_HU01.fbx",
      "SK_FANT_KNGT_17_27AHPL_HU01.fbx",
      "SK_FANT_KNGT_17_28AHPR_HU01.fbx",
      "SK_FANT_KNGT_17_29ASHL_HU01.fbx",
      "SK_FANT_KNGT_17_30ASHR_HU01.fbx",
      "SK_FANT_KNGT_17_31AEBL_HU01.fbx",
      "SK_FANT_KNGT_17_32AEBR_HU01.fbx",
      "SK_FANT_KNGT_17_33AKNL_HU01.fbx",
      "SK_FANT_KNGT_17_34AKNR_HU01.fbx",

      // Sci-fi civl 09 (from your list)
      "SK_SCFI_CIVL_09_02HAIR_HU01.fbx",
      "SK_SCFI_CIVL_09_10TORS_HU01.fbx",
      "SK_SCFI_CIVL_09_11AUPL_HU01.fbx",
      "SK_SCFI_CIVL_09_12AUPR_HU01.fbx",
      "SK_SCFI_CIVL_09_13ALWL_HU01.fbx",
      "SK_SCFI_CIVL_09_14ALWR_HU01.fbx",
      "SK_SCFI_CIVL_09_15HNDL_HU01.fbx",
      "SK_SCFI_CIVL_09_16HNDR_HU01.fbx",
      "SK_SCFI_CIVL_09_17HIPS_HU01.fbx",
      "SK_SCFI_CIVL_09_18LEGL_HU01.fbx",
      "SK_SCFI_CIVL_09_19LEGR_HU01.fbx",
      "SK_SCFI_CIVL_09_20FOTL_HU01.fbx",
      "SK_SCFI_CIVL_09_21FOTR_HU01.fbx",
      "SK_SCFI_CIVL_09_22AHED_HU01.fbx",
      "SK_SCFI_CIVL_09_23AFAC_HU01.fbx",
      "SK_SCFI_CIVL_09_24ABAC_HU01.fbx",
      "SK_SCFI_CIVL_09_25AHPF_HU01.fbx",
      "SK_SCFI_CIVL_09_26AHPB_HU01.fbx",
      "SK_SCFI_CIVL_09_27AHPL_HU01.fbx",
      "SK_SCFI_CIVL_09_28AHPR_HU01.fbx",
      "SK_SCFI_CIVL_09_29ASHL_HU01.fbx",
      "SK_SCFI_CIVL_09_30ASHR_HU01.fbx",
      "SK_SCFI_CIVL_09_31AEBL_HU01.fbx",
      "SK_SCFI_CIVL_09_32AEBR_HU01.fbx",
      "SK_SCFI_CIVL_09_33AKNL_HU01.fbx",
      "SK_SCFI_CIVL_09_34AKNR_HU01.fbx",

      // Sci-fi civl 10 (from your list)
      "SK_SCFI_CIVL_10_22AHED_HU01.fbx",
      "SK_SCFI_CIVL_10_26AHPB_HU01.fbx",
      "SK_SCFI_CIVL_10_27AHPL_HU01.fbx",
      "SK_SCFI_CIVL_10_28AHPR_HU01.fbx",
      "SK_SCFI_CIVL_10_29ASHL_HU01.fbx",
      "SK_SCFI_CIVL_10_30ASHR_HU01.fbx"
    ];

    /* -------------------- UI refs -------------------- */
    const stage = document.getElementById("stage");
    const stageFS = document.getElementById("stageFS");
    const loadedOut = document.getElementById("loadedOut");
    const loadedOutFS = document.getElementById("loadedOutFS");
    const statusOut = document.getElementById("statusOut");
    const basePathOut = document.getElementById("basePathOut");
    const wipBadge = document.getElementById("wipBadge");

    basePathOut.textContent = BASE_FBX;

    const btnLoadBase = document.getElementById("btnLoadBase");
    const btnReset = document.getElementById("btnReset");
    const btnApplyTex = document.getElementById("btnApplyTex");
    const btnClear = document.getElementById("btnClear");

    const btnFullscreen = document.getElementById("btnFullscreen");
    const fsOverlay = document.getElementById("fsOverlay");
    const btnCloseFS = document.getElementById("btnCloseFS");

    const selects = {
      head:   document.getElementById("selHead"),
      hair:   document.getElementById("selHair"),
      face:   document.getElementById("selFace"),
      torso:  document.getElementById("selTorso"),
      arms:   document.getElementById("selArms"),
      hands:  document.getElementById("selHands"),
      hips:   document.getElementById("selHips"),
      legs:   document.getElementById("selLegs"),
      feet:   document.getElementById("selFeet"),
      extras: document.getElementById("selExtras")
    };

    function setStatus(msg, ok=true){
      statusOut.textContent = "Status: " + msg;
      statusOut.style.borderColor = ok ? "rgba(120,255,160,.18)" : "rgba(255,120,120,.22)";
      statusOut.style.color = ok ? "rgba(200,255,210,.85)" : "rgba(255,200,200,.85)";
    }

    function markWorking(){
      // Hide the WIP badge once any FBX successfully loads
      wipBadge.classList.add("wipHidden");
    }

    /* -------------------- Three setup -------------------- */
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    // We will move the SAME canvas between normal and fullscreen containers.
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(45, 1, 0.01, 5000);
    camera.position.set(0, 1.4, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 1.1, 0);

    // Lights (fix “black silhouette” look)
    const hemi = new THREE.HemisphereLight(0xcfe3ff, 0x101018, 1.05);
    scene.add(hemi);

    const key = new THREE.DirectionalLight(0xffffff, 1.25);
    key.position.set(2.5, 4.5, 3.0);
    scene.add(key);

    const fill = new THREE.DirectionalLight(0x9bbcff, 0.55);
    fill.position.set(-3.0, 1.8, -2.5);
    scene.add(fill);

    const rim = new THREE.DirectionalLight(0xffffff, 0.35);
    rim.position.set(0, 3.5, -4.0);
    scene.add(rim);

    // Subtle ground reference
    const grid = new THREE.GridHelper(10, 20, 0x334455, 0x223344);
    grid.material.transparent = true;
    grid.material.opacity = 0.18;
    scene.add(grid);

    const root = new THREE.Group();
    scene.add(root);

    // Track equipped slot meshes
    const slotObjects = new Map(); // slotName -> Object3D
    let baseObject = null;

    function resize(){
      // If fullscreen is open, size to that container; else size to normal stage.
      const host = fsOverlay.classList.contains("show") ? stageFS : stage;
      const w = host.clientWidth;
      const h = host.clientHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    /* -------------------- Helpers -------------------- */
    const fbxLoader = new FBXLoader();
    const texLoader = new THREE.TextureLoader();

    function clearScene(){
      for (const [slot,obj] of slotObjects){
        root.remove(obj);
      }
      slotObjects.clear();

      if (baseObject){
        root.remove(baseObject);
        baseObject = null;
      }
      loadedOut.textContent = "Loaded: (none)";
      loadedOutFS.textContent = "Loaded: (none)";
      setStatus("Cleared.");
    }

    function computeBox(obj){
      const box = new THREE.Box3().setFromObject(obj);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      return { box, size, center };
    }

    function frameObject(obj){
      const { size, center } = computeBox(obj);
      const maxDim = Math.max(size.x, size.y, size.z);
      const fitDist = maxDim / (2 * Math.tan(THREE.MathUtils.degToRad(camera.fov * 0.5)));
      const dist = fitDist * 1.35;

      controls.target.copy(center);
      camera.position.set(center.x + dist*0.35, center.y + dist*0.20, center.z + dist);
      camera.near = Math.max(0.01, maxDim / 500);
      camera.far = Math.max(1000, maxDim * 50);
      camera.updateProjectionMatrix();
      controls.update();
    }

    function normalizeMaterials(obj){
      obj.traverse(child=>{
        if (!child.isMesh) return;

        const old = child.material;
        const mats = Array.isArray(old) ? old : [old];

        const newMats = mats.map(m=>{
          return new THREE.MeshStandardMaterial({
            color: (m && m.color) ? m.color.clone() : new THREE.Color(0xffffff),
            roughness: 0.9,
            metalness: 0.05
          });
        });

        child.material = Array.isArray(old) ? newMats : newMats[0];
      });
    }

    async function applyBaseTexturesTo(obj){
      setStatus("Loading textures...");
      const tColor = await texLoader.loadAsync(TEX.color);
      tColor.colorSpace = THREE.SRGBColorSpace;

      let tEmissive=null, tOpacity=null, tMetal=null, tRough=null;
      try { tEmissive = await texLoader.loadAsync(TEX.emissive); } catch {}
      try { tOpacity  = await texLoader.loadAsync(TEX.opacity); } catch {}
      try { tMetal    = await texLoader.loadAsync(TEX.reflection); } catch {}
      try { tRough    = await texLoader.loadAsync(TEX.smoothness); } catch {}
      if (tEmissive) tEmissive.colorSpace = THREE.SRGBColorSpace;

      obj.traverse(child=>{
        if (!child.isMesh) return;
        const mats = Array.isArray(child.material) ? child.material : [child.material];
        mats.forEach(mat=>{
          mat.map = tColor;

          if (tEmissive){
            mat.emissive = new THREE.Color(0xffffff);
            mat.emissiveMap = tEmissive;
            mat.emissiveIntensity = 0.25;
          }
          if (tOpacity){
            mat.alphaMap = tOpacity;
            mat.transparent = true;
            mat.opacity = 1.0;
          }
          if (tMetal){
            mat.metalness = 0.15;
            mat.metalnessMap = tMetal;
          }
          if (tRough){
            mat.roughness = 0.85;
            mat.roughnessMap = tRough;
          }
          mat.needsUpdate = true;
        });
      });

      setStatus("Textures applied.");
    }

    function loadFBX(path){
      return new Promise((resolve,reject)=>{
        fbxLoader.load(path, resolve, undefined, reject);
      });
    }

    /* -------------------- Slot logic (auto-sort filenames) -------------------- */
    function slotFromFilename(fn){
      const u = fn.toUpperCase();
      if (u.includes("HAIR")) return "hair";
      if (u.includes("AHED")) return "head";
      if (u.includes("AFAC") || u.includes("ABAC")) return "face";
      if (u.includes("TORS")) return "torso";
      if (u.includes("AUPL") || u.includes("AUPR") || u.includes("ALWL") || u.includes("ALWR")) return "arms";
      if (u.includes("HNDL") || u.includes("HNDR")) return "hands";
      if (u.includes("HIPS")) return "hips";
      if (u.includes("LEGL") || u.includes("LEGR") || u.includes("AKNL") || u.includes("AKNR")) return "legs";
      if (u.includes("FOTL") || u.includes("FOTR")) return "feet";
      if (u.includes("AHP") || u.includes("AEB") || u.includes("ASH")) return "extras";
      return "extras";
    }

    function buildPartLists(){
      const buckets = { head:[], hair:[], face:[], torso:[], arms:[], hands:[], hips:[], legs:[], feet:[], extras:[] };
      PART_FILES.forEach(fn=>{
        if (!fn.toLowerCase().endsWith(".fbx")) return;
        const slot = slotFromFilename(fn);
        buckets[slot].push(fn);
      });
      Object.keys(buckets).forEach(k=>buckets[k].sort());
      return buckets;
    }

    function fillSelect(selectEl, files){
      selectEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "(none)";
      selectEl.appendChild(opt0);

      files.forEach(fn=>{
        const opt = document.createElement("option");
        opt.value = fn;
        opt.textContent = fn.replace(".fbx","");
        selectEl.appendChild(opt);
      });
    }

    function initDropdowns(){
      const lists = buildPartLists();
      fillSelect(selects.head, lists.head);
      fillSelect(selects.hair, lists.hair);
      fillSelect(selects.face, lists.face);
      fillSelect(selects.torso, lists.torso);
      fillSelect(selects.arms, lists.arms);
      fillSelect(selects.hands, lists.hands);
      fillSelect(selects.hips, lists.hips);
      fillSelect(selects.legs, lists.legs);
      fillSelect(selects.feet, lists.feet);
      fillSelect(selects.extras, lists.extras);
    }
    initDropdowns();

    async function equip(slot, filename){
      if (slotObjects.has(slot)){
        root.remove(slotObjects.get(slot));
        slotObjects.delete(slot);
      }
      if (!filename){
        setStatus(`Removed ${slot}.`);
        return;
      }

      const path = "assets/models/" + filename;
      setStatus(`Loading ${slot}...`);
      try{
        const obj = await loadFBX(path);
        normalizeMaterials(obj);
        root.add(obj);
        slotObjects.set(slot, obj);

        loadedOut.textContent = `Loaded: ${filename}`;
        loadedOutFS.textContent = `Loaded: ${filename}`;
        setStatus(`Equipped ${slot}.`);
        markWorking();

        frameObject(baseObject || obj);
      }catch(e){
        console.error(e);
        setStatus(`Failed to load ${filename} (check path/case + LFS).`, false);
      }
    }

    // Hook up selects
    selects.head.addEventListener("change", e=>equip("head", e.target.value));
    selects.hair.addEventListener("change", e=>equip("hair", e.target.value));
    selects.face.addEventListener("change", e=>equip("face", e.target.value));
    selects.torso.addEventListener("change", e=>equip("torso", e.target.value));
    selects.arms.addEventListener("change", e=>equip("arms", e.target.value));
    selects.hands.addEventListener("change", e=>equip("hands", e.target.value));
    selects.hips.addEventListener("change", e=>equip("hips", e.target.value));
    selects.legs.addEventListener("change", e=>equip("legs", e.target.value));
    selects.feet.addEventListener("change", e=>equip("feet", e.target.value));
    selects.extras.addEventListener("change", e=>equip("extras", e.target.value));

    /* -------------------- Buttons -------------------- */
    btnClear.addEventListener("click", clearScene);

    btnReset.addEventListener("click", ()=>{
      const targetObj = baseObject || (slotObjects.size ? [...slotObjects.values()][0] : null);
      if (targetObj) frameObject(targetObj);
      else setStatus("Nothing to frame.");
    });

    btnLoadBase.addEventListener("click", async ()=>{
      setStatus("Loading base...");
      try{
        if (baseObject){
          frameObject(baseObject);
          setStatus("Base already loaded.");
          markWorking();
          return;
        }

        const obj = await loadFBX(BASE_FBX);
        normalizeMaterials(obj);
        baseObject = obj;
        root.add(obj);

        loadedOut.textContent = "Loaded: SK_BaseModel.fbx";
        loadedOutFS.textContent = "Loaded: SK_BaseModel.fbx";
        setStatus("Base loaded.");
        markWorking();
        frameObject(obj);

      }catch(e){
        console.error(e);
        setStatus("Failed to load base (check BASE_FBX path/case + LFS).", false);
      }
    });

    btnApplyTex.addEventListener("click", async ()=>{
      const target = baseObject;
      if (!target){
        setStatus("Load base first, then apply textures.", false);
        return;
      }
      try{
        await applyBaseTexturesTo(target);
        frameObject(target);
      }catch(e){
        console.error(e);
        setStatus("Texture apply failed (check assets/texture/ paths).", false);
      }
    });

    /* -------------------- Fullscreen Showcase -------------------- */
    function openFS(){
      fsOverlay.classList.add("show");
      stageFS.appendChild(renderer.domElement); // move canvas into FS
      resize();
    }
    function closeFS(){
      fsOverlay.classList.remove("show");
      stage.appendChild(renderer.domElement);   // move canvas back
      resize();
    }
    btnFullscreen.addEventListener("click", openFS);
    btnCloseFS.addEventListener("click", closeFS);
    fsOverlay.addEventListener("click", (e)=>{
      if (e.target === fsOverlay) closeFS();
    });
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape" && fsOverlay.classList.contains("show")) closeFS();
    });

    setStatus("Ready.");
    resize();
  </script>
</body>
</html>
