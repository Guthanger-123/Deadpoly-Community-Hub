<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeadPoly Wiki - 3D Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#07090e;
      --panel:rgba(18,22,32,.75);
      --panel2:rgba(10,12,18,.65);
      --border:rgba(255,255,255,.10);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.70);
      --btn:rgba(40,55,90,.55);
      --btn2:rgba(30,36,52,.55);
      --btnHover:rgba(70,95,160,.60);
      --accent:#8bb3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 30% 10%, rgba(40,65,120,.30), transparent 60%),
                  radial-gradient(900px 700px at 75% 25%, rgba(25,35,70,.35), transparent 55%),
                  linear-gradient(180deg, #060812, #05060a 60%, #04040a);
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(10,12,18,.85), rgba(10,12,18,.55));
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:10;
    }
    .top-left{display:flex; gap:10px; align-items:center;}
    .top-mid{display:flex; gap:12px; align-items:center; justify-content:center; flex:1;}
    .top-right{display:flex; gap:8px; align-items:center;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      border-radius:999px;
      color:var(--text);
      text-decoration:none;
      font-weight:600;
      font-size:13px;
      line-height:1;
      user-select:none;
      transition:background .12s ease, transform .12s ease;
    }
    .pill:hover{background:rgba(255,255,255,.08)}
    .title{
      font-weight:800;
      letter-spacing:.2px;
    }
    .subhint{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Layout */
    .wrap{
      height:calc(100vh - 56px);
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      padding:14px;
    }

    .viewer, .side{
      border:1px solid var(--border);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(18,22,32,.70), rgba(10,12,18,.55));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      overflow:hidden;
      min-height:0;
    }

    .viewer{
      position:relative;
    }
    #stage{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
    }
    .status{
      position:absolute;
      left:12px; bottom:12px;
      background:rgba(0,0,0,.35);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      color:var(--muted);
      max-width:min(520px, 90%);
      backdrop-filter: blur(8px);
    }

    .side{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
    }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
      border-radius:14px;
      padding:12px;
    }
    .card h3{
      margin:0 0 4px 0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card .small{
      font-size:12px;
      color:var(--muted);
      margin:0 0 10px 0;
    }

    button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--btn2);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease;
    }
    button:hover{background:var(--btnHover)}
    button.primary{background:var(--btn); border-color:rgba(139,179,255,.35)}
    button.primary:hover{background:rgba(90,130,220,.45)}
    button:active{transform:scale(.99)}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
      font-weight:700;
    }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }

    .note{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      color:rgba(232,238,252,.85);
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:10px;
      overflow:auto;
    }

    /* Mobile */
    @media (max-width: 980px){
      body{overflow:auto}
      .wrap{
        height:auto;
        grid-template-columns: 1fr;
      }
      .viewer{height:64vh; min-height:420px}
      #stage{position:absolute}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="top-left">
      <a class="pill" href="index.html">← Menu</a>
      <div class="title">Wiki - 3D Viewer</div>
    </div>

    <div class="top-mid">
      <div class="subhint">Drag to rotate • Scroll to zoom • Right-drag to pan</div>
    </div>

    <div class="top-right">
      <a class="pill" href="tips.html">Tips</a>
      <a class="pill" href="maps.html">Maps</a>
    </div>
  </div>

  <div class="wrap">
    <div class="viewer">
      <div id="stage"></div>
      <div class="status" id="status">Status: Ready.</div>
    </div>

    <div class="side">
      <div class="card">
        <h3>Controls</h3>
        <p class="small">Loads FBX from <span class="mono">assets/models/</span></p>

        <button class="primary" id="btnLoadBase">Load Base Model</button>
        <button id="btnReset">Reset View</button>
        <button id="btnApplyTex">Apply Base Textures</button>
        <button id="btnClear">Clear Scene</button>

        <p class="note" style="margin-top:10px">
          If the model loads but looks dark, hit <b>Apply Base Textures</b> and make sure textures are in
          <span class="mono">assets/texture/</span> (exact capitalization matters).
        </p>

        <div class="mono" style="margin-top:10px">
Base: assets/models/SK_BaseModel.fbx<br/>
Textures: assets/texture/T_ColorMap.png etc
        </div>
      </div>

      <div class="card">
        <h3>Character Parts</h3>
        <p class="small">Choose a part per slot (select <b>None</b> to remove).</p>

        <label>Head</label>
        <select id="selHead"></select>

        <label>Hair</label>
        <select id="selHair"></select>

        <label>Face / Mask</label>
        <select id="selFace"></select>

        <label>Torso</label>
        <select id="selTorso"></select>

        <label>Arms (Upper / Lower)</label>
        <select id="selArms"></select>

        <label>Hands</label>
        <select id="selHands"></select>

        <label>Hips</label>
        <select id="selHips"></select>

        <label>Legs / Knees</label>
        <select id="selLegs"></select>

        <label>Feet</label>
        <select id="selFeet"></select>

        <label>Extras / Other</label>
        <select id="selExtras"></select>

        <p class="note" style="margin-top:10px">
          Important: this “equips” parts by adding FBX objects into the same scene.
          For perfect alignment, parts must share the same skeleton/origin scale as the base.
        </p>
      </div>

      <div class="card">
        <h3>Add / Remove parts (quick)</h3>
        <div class="note">
          You can add more files by editing the lists in the script:
          <div class="mono" style="margin-top:8px;">
parts.head.push("NewFile.fbx");
          </div>
          GitHub Pages can’t auto-scan folders, so the dropdowns must be hard-coded.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { FBXLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/FBXLoader.js";

    const statusEl = document.getElementById("status");
    const stage = document.getElementById("stage");

    function setStatus(msg){ statusEl.textContent = "Status: " + msg; }

    // --- Paths (match your repo) ---
    const BASE_FBX = "assets/models/SK_BaseModel.fbx";
    const MODEL_DIR = "assets/models/";
    const TEX_DIR = "assets/texture/"; // <-- your folder is "texture" (not "textures")

    const TEX = {
      color:      TEX_DIR + "T_ColorMap.png",
      opacity:    TEX_DIR + "T_OpacityMap.png",
      emission:   TEX_DIR + "T_EmissionMap.png",
      reflection: TEX_DIR + "T_ReflectionMap.png",
      smoothness: TEX_DIR + "T_SmoothnessMap.png",
    };

    // --- Your parts (from your list / filenames) ---
    // Put files EXACTLY as they appear in /assets/models/
    const parts = {
      head: [
        "SK_FANT_KNGT_17_22AHED_HU01.fbx",
        "SK_SCFI_CIVL_09_22AHED_HU01.fbx",
        "SK_SCFI_CIVL_10_22AHED_HU01.fbx",
        "SK_HORR_VILN_01_22AHED_HU01.fbx",
      ],
      hair: [
        "SK_SCFI_CIVL_09_02HAIR_HU01.fbx"
      ],
      face: [
        "SK_FANT_KNGT_17_23AFAC_HU01.fbx",
        "SK_SCFI_CIVL_09_23AFAC_HU01.fbx"
      ],
      torso: [
        "SK_FANT_KNGT_17_10TORS_HU01.fbx",
        "SK_SCFI_CIVL_09_10TORS_HU01.fbx"
      ],
      arms: [
        "SK_FANT_KNGT_17_11AUPL_HU01.fbx",
        "SK_FANT_KNGT_17_12AUPR_HU01.fbx",
        "SK_FANT_KNGT_17_13ALWL_HU01.fbx",
        "SK_FANT_KNGT_17_14ALWR_HU01.fbx",
        "SK_SCFI_CIVL_09_11AUPL_HU01.fbx",
        "SK_SCFI_CIVL_09_12AUPR_HU01.fbx",
        "SK_SCFI_CIVL_09_13ALWL_HU01.fbx",
        "SK_SCFI_CIVL_09_14ALWR_HU01.fbx"
      ],
      hands: [
        "SK_FANT_KNGT_17_15HNDL_HU01.fbx",
        "SK_FANT_KNGT_17_16HNDR_HU01.fbx",
        "SK_SCFI_CIVL_09_15HNDL_HU01.fbx",
        "SK_SCFI_CIVL_09_16HNDR_HU01.fbx"
      ],
      hips: [
        "SK_FANT_KNGT_17_17HIPS_HU01.fbx",
        "SK_SCFI_CIVL_09_17HIPS_HU01.fbx"
      ],
      legs: [
        "SK_FANT_KNGT_17_18LEGL_HU01.fbx",
        "SK_FANT_KNGT_17_19LEGR_HU01.fbx",
        "SK_SCFI_CIVL_09_18LEGL_HU01.fbx",
        "SK_SCFI_CIVL_09_19LEGR_HU01.fbx",
        "SK_FANT_KNGT_17_33AKNL_HU01.fbx",
        "SK_FANT_KNGT_17_34AKNR_HU01.fbx",
        "SK_SCFI_CIVL_09_33AKNL_HU01.fbx",
        "SK_SCFI_CIVL_09_34AKNR_HU01.fbx"
      ],
      feet: [
        "SK_FANT_KNGT_17_20FOTL_HU01.fbx",
        "SK_FANT_KNGT_17_21FOTR_HU01.fbx",
        "SK_SCFI_CIVL_09_20FOTL_HU01.fbx",
        "SK_SCFI_CIVL_09_21FOTR_HU01.fbx"
      ],
      extras: [
        "SK_FANT_KNGT_17_25AHPF_HU01.fbx",
        "SK_FANT_KNGT_17_26AHPB_HU01.fbx",
        "SK_FANT_KNGT_17_27AHPL_HU01.fbx",
        "SK_FANT_KNGT_17_28AHPR_HU01.fbx",
        "SK_SCFI_CIVL_09_24ABAC_HU01.fbx",
        "SK_SCFI_CIVL_09_25AHPF_HU01.fbx",
        "SK_SCFI_CIVL_09_26AHPB_HU01.fbx",
        "SK_SCFI_CIVL_09_27AHPL_HU01.fbx",
        "SK_SCFI_CIVL_09_28AHPR_HU01.fbx",
        "SK_SCFI_CIVL_09_29ASHL_HU01.fbx",
        "SK_SCFI_CIVL_09_30ASHR_HU01.fbx",
        "SK_FANT_KNGT_17_29ASHL_HU01.fbx",
        "SK_FANT_KNGT_17_30ASHR_HU01.fbx"
      ]
    };

    // --- Three.js setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x07090e);

    const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 5000);
    camera.position.set(0, 1.4, 3.0);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.25; // brightens
    stage.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 1.1, 0);

    // Lighting (fixes silhouette)
    const hemi = new THREE.HemisphereLight(0xbad6ff, 0x111122, 0.95);
    scene.add(hemi);

    const key = new THREE.DirectionalLight(0xffffff, 1.35);
    key.position.set(3, 6, 4);
    scene.add(key);

    const fill = new THREE.DirectionalLight(0x9db9ff, 0.55);
    fill.position.set(-4, 2.5, -3);
    scene.add(fill);

    // Helpers
    const grid = new THREE.GridHelper(12, 12, 0x223044, 0x121a26);
    grid.position.y = 0;
    grid.material.opacity = 0.30;
    grid.material.transparent = true;
    scene.add(grid);

    // Track loaded objects by "slot"
    const loaded = {
      base: null,
      slots: new Map() // slotName -> Object3D
    };

    const fbxLoader = new FBXLoader();

    // Resize fix (this is why you can get blank canvas)
    function resize(){
      const w = stage.clientWidth;
      const h = stage.clientHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    function animate(){
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    // --- Utility: frame camera to object ---
    function frameObject(object3D){
      const box = new THREE.Box3().setFromObject(object3D);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      // Put orbit target on center
      controls.target.copy(center);

      // Move camera back enough to fit
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      let dist = (maxDim / 2) / Math.tan(fov / 2);
      dist *= 1.35;

      const dir = new THREE.Vector3(0.4, 0.25, 1).normalize();
      camera.position.copy(center.clone().add(dir.multiplyScalar(dist)));
      camera.near = Math.max(0.01, dist / 200);
      camera.far  = Math.max(2000, dist * 200);
      camera.updateProjectionMatrix();
      controls.update();
    }

    // --- Apply textures to meshes ---
    const texLoader = new THREE.TextureLoader();
    let cachedTex = null;

    function loadTextures(){
      if (cachedTex) return Promise.resolve(cachedTex);

      const t = {};
      const p = (k, url) => new Promise((res, rej) => {
        texLoader.load(url, tex => res([k, tex]), undefined, err => rej({k, url, err}));
      });

      return Promise.all([
        p("color", TEX.color),
        p("opacity", TEX.opacity),
        p("emission", TEX.emission),
        p("reflection", TEX.reflection),
        p("smoothness", TEX.smoothness),
      ]).then(entries => {
        for (const [k, tex] of entries) t[k] = tex;

        // Color map must be sRGB
        t.color.colorSpace = THREE.SRGBColorSpace;

        cachedTex = t;
        return t;
      });
    }

    function applyTexturesToObject(obj){
      return loadTextures().then(t => {
        obj.traverse(child => {
          if (!child.isMesh) return;

          const mat = new THREE.MeshStandardMaterial({
            map: t.color,
            transparent: true,
            alphaMap: t.opacity,
            alphaTest: 0.15,
            emissive: new THREE.Color(0xffffff),
            emissiveMap: t.emission,
            emissiveIntensity: 0.8,
            metalness: 0.15,
            roughness: 0.70,
          });

          // Smoothness -> roughness approximation (roughness = 1 - smoothness)
          // We'll sample it as roughnessMap but invert visually by setting roughness low-ish.
          // (True inversion needs a shader; this is “good enough” for preview.)
          mat.roughnessMap = t.smoothness;
          mat.metalnessMap = t.reflection;

          child.material = mat;
          child.castShadow = false;
          child.receiveShadow = false;
        });
        setStatus("Textures applied.");
      }).catch(e => {
        console.error("Texture load failed:", e);
        setStatus("Texture load failed. Check assets/texture/ filenames.");
      });
    }

    // --- Load FBX and add to scene ---
    function loadFBX(path){
      return new Promise((resolve, reject) => {
        fbxLoader.load(
          path,
          obj => resolve(obj),
          undefined,
          err => reject(err)
        );
      });
    }

    async function loadBase(){
      try{
        setStatus("Loading base model...");
        const obj = await loadFBX(BASE_FBX);

        // Remove old base
        if (loaded.base) scene.remove(loaded.base);
        loaded.base = obj;
        obj.name = "BASE";

        scene.add(obj);
        frameObject(obj);
        setStatus("Base model loaded.");
      }catch(err){
        console.error(err);
        setStatus("Base load failed. Check path + filename case.");
      }
    }

    function clearScene(){
      // Remove base + all slots
      if (loaded.base){ scene.remove(loaded.base); loaded.base = null; }
      for (const [, obj] of loaded.slots){ scene.remove(obj); }
      loaded.slots.clear();
      setStatus("Scene cleared.");
    }

    async function equipSlot(slotName, fileNameOrNone){
      // Remove existing in slot
      if (loaded.slots.has(slotName)){
        scene.remove(loaded.slots.get(slotName));
        loaded.slots.delete(slotName);
      }
      if (!fileNameOrNone || fileNameOrNone === "__none__"){
        setStatus(slotName + " removed.");
        return;
      }

      try{
        setStatus("Loading " + slotName + "...");
        const obj = await loadFBX(MODEL_DIR + fileNameOrNone);
        obj.name = "SLOT_" + slotName.toUpperCase();
        scene.add(obj);
        loaded.slots.set(slotName, obj);
        setStatus(slotName + " equipped: " + fileNameOrNone);
      }catch(err){
        console.error(err);
        setStatus("Failed to load " + fileNameOrNone + " (check name/case).");
      }
    }

    // --- Dropdown builder ---
    function populateSelect(sel, items){
      sel.innerHTML = "";
      const optNone = document.createElement("option");
      optNone.value = "__none__";
      optNone.textContent = "None";
      sel.appendChild(optNone);

      items.forEach(fn => {
        const opt = document.createElement("option");
        opt.value = fn;
        opt.textContent = fn;
        sel.appendChild(opt);
      });
      sel.value = "__none__";
    }

    // Hook selects
    const selHead   = document.getElementById("selHead");
    const selHair   = document.getElementById("selHair");
    const selFace   = document.getElementById("selFace");
    const selTorso  = document.getElementById("selTorso");
    const selArms   = document.getElementById("selArms");
    const selHands  = document.getElementById("selHands");
    const selHips   = document.getElementById("selHips");
    const selLegs   = document.getElementById("selLegs");
    const selFeet   = document.getElementById("selFeet");
    const selExtras = document.getElementById("selExtras");

    populateSelect(selHead, parts.head);
    populateSelect(selHair, parts.hair);
    populateSelect(selFace, parts.face);
    populateSelect(selTorso, parts.torso);
    populateSelect(selArms, parts.arms);
    populateSelect(selHands, parts.hands);
    populateSelect(selHips, parts.hips);
    populateSelect(selLegs, parts.legs);
    populateSelect(selFeet, parts.feet);
    populateSelect(selExtras, parts.extras);

    selHead.addEventListener("change",   e => equipSlot("head",   e.target.value));
    selHair.addEventListener("change",   e => equipSlot("hair",   e.target.value));
    selFace.addEventListener("change",   e => equipSlot("face",   e.target.value));
    selTorso.addEventListener("change",  e => equipSlot("torso",  e.target.value));
    selArms.addEventListener("change",   e => equipSlot("arms",   e.target.value));
    selHands.addEventListener("change",  e => equipSlot("hands",  e.target.value));
    selHips.addEventListener("change",   e => equipSlot("hips",   e.target.value));
    selLegs.addEventListener("change",   e => equipSlot("legs",   e.target.value));
    selFeet.addEventListener("change",   e => equipSlot("feet",   e.target.value));
    selExtras.addEventListener("change", e => equipSlot("extras", e.target.value));

    // Buttons
    document.getElementById("btnLoadBase").addEventListener("click", loadBase);
    document.getElementById("btnReset").addEventListener("click", () => {
      if (loaded.base) frameObject(loaded.base);
      else {
        controls.target.set(0,1.1,0);
        camera.position.set(0,1.4,3.0);
        controls.update();
      }
      setStatus("View reset.");
    });
    document.getElementById("btnClear").addEventListener("click", clearScene);
    document.getElementById("btnApplyTex").addEventListener("click", async () => {
      if (!loaded.base){
        setStatus("Load base model first.");
        return;
      }
      setStatus("Applying textures...");
      await applyTexturesToObject(loaded.base);
    });

    // Start
    setStatus("Ready. Click 'Load Base Model'.");
  </script>
</body>
</html>
