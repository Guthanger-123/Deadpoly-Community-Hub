<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Delta Interactive Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GD7LNZHQMM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-GD7LNZHQMM');
  </script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100vh; }

    .panel { position:absolute; z-index:1000; background:rgba(30,30,30,.9); color:#fff; border-radius:8px; }
    .filters { top:10px; right:10px; padding:8px 10px; font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .filters h4 { margin:.2rem 0 .4rem; font-size:13px; }
    .filters label { display:block; margin:6px 0 0; cursor:pointer; }
    .legend  { bottom:10px; right:10px; padding:6px 8px; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    .leaflet-control.custom-btn {
      background:#222; color:#fff; border:1px solid #555; border-radius:8px;
      padding:6px 10px; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .leaflet-control.custom-btn a { color:#fff; text-decoration:none; display:block; }

    .mode-row { display:flex; gap:10px; flex-wrap:wrap; margin:0 0 8px; }
    .mode-row label { display:flex; gap:6px; align-items:center; margin:0; }

    .map-banner {
      position:absolute; top:8px; left:50%; transform:translateX(-50%);
      z-index:1100; pointer-events:none;
    }
    .map-banner img { max-width:320px; width:28vw; height:auto; filter:drop-shadow(0 2px 6px rgba(0,0,0,.5)); }

    .coords { top:10px; left:10px; padding:6px 8px; }
    .coords code { background:rgba(0,0,0,.12); padding:2px 4px; border-radius:4px; }

    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      z-index:2000;
    }
    .modal {
      background:#1e1e1e; color:#fff; border:1px solid #444; border-radius:10px;
      width:min(420px, 92vw); padding:14px 16px; box-shadow:0 12px 30px rgba(0,0,0,.45);
      font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      position:relative;
    }
    .modal h3 { margin:0 0 8px; font-size:16px; }
    .modal p  { margin:4px 0; }
    .modal .byline { opacity:.8; font-size:12px; margin-top:6px; }
    .modal .actions { display:flex; gap:8px; margin-top:12px; justify-content:flex-end; }
    .modal button {
      background:#2b2b2b; color:#fff; border:1px solid #555; border-radius:8px; padding:6px 10px; cursor:pointer;
    }
    .modal button:hover { background:#343434; }
    .modal .close-x {
      position:absolute; top:6px; right:8px; background:transparent; border:none; color:#bbb; font-size:18px; cursor:pointer;
    }
    .modal .close-x:hover { color:#fff; }
  </style>
</head>

<body>
  <div id="map" aria-label="Delta interactive map"></div>

  <div class="map-banner">
    <img alt="DeadPoly" src="assets/deadpoly_hor-wht.png">
  </div>

  <div class="panel filters" id="filterPanel"><h4>Key</h4></div>
  <div class="panel legend" id="legendPanel"></div>

  <div class="panel coords" id="coordsPanel" title="Click anywhere on the map to copy coordinates">
    Click map → coords: <code id="coordsOut">—</code>
  </div>

  <div class="modal-backdrop" id="wipModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wipTitle">
      <button class="close-x" aria-label="Close">×</button>
      <h3 id="wipTitle">Work In Progress</h3>
      <p>This map is a <b>Work In Progress</b>. To see different markers, use the checkboxes in the <b>Key</b> panel.</p>
      <p class="byline">Created by <b>Guthanger123</b>.</p>
      <p class="byline">Contributors: <b>Deadpoly Community</b>.</p>
      <div class="actions"><button id="wipOk">OK</button></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  /* ==================== CONFIG ==================== */

  // IMPORTANT: your repo shows assets/delta.png exists. Use that exact name.
  const SURFACE_IMAGE_URL     = 'assets/delta.png';
  const UNDERGROUND_IMAGE_URL = 'assets/delta.png';   // swap later if you have an underground image
  const QUESTS_IMAGE_URL      = 'assets/delta.png';   // swap later if you have a quests image

  // Set these to your real delta image pixel size.
  // If the image is NOT 1264x1264, update these or clicks/markers will be off.
  const IMAGE_WIDTH  = 1264;
  const IMAGE_HEIGHT = 1264;

  // Start view center + desired start zoom
  const START = { x: IMAGE_WIDTH/2, y: IMAGE_HEIGHT/2, zoom: 2 };

  const categoryIconMap = {
    'Point Of Interest': { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',   iconSize: [25,41], iconAnchor: [12,41] },
    'Hunting Zones':     { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png', iconSize: [25,41], iconAnchor: [12,41] },
    'Spoilers':          { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',    iconSize: [25,41], iconAnchor: [12,41] },
    'Trader':            { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',   iconSize: [25,41], iconAnchor: [12,41] },
    'Secret Stashes':    { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',   iconSize: [25,41], iconAnchor: [12,41] },
    'Bunker Layouts':    { iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png', iconSize: [25,41], iconAnchor: [12,41] }
  };

  /* ======== MARKERS (DELTA) ======== */
  // Paste your full original Delta marker list here if you want it identical.
  // These are the ones you previously posted for Delta.
  const markersSurface = [
    { name:'Bunker Delta', x:850, y:565, category:'Spoilers', desc:'Unopenable For Now?.' },

    { name:'Hunting Zone (North)', x:380, y:356, category:'Hunting Zones', desc:'Deer, Bears.' },
    { name:'Hunting Zone (East)',  x:902, y:368, category:'Hunting Zones', desc:'Deer, Bears.' },
    { name:'Hunting Zone (South)', x:650, y:950, category:'Hunting Zones', desc:'Deer, Bears.' },

    { name:'Swanson',    x:645, y:381, category:'Trader', desc:'Materials.' },
    { name:'Tallehase',  x:800, y:272, category:'Trader', desc:'Arms Dealer.' },
    { name:'Elizabeth',  x:791, y:193, category:'Trader', desc:'Arms Dealer.' },

    { name:'Junkyard',    x:792, y:293, category:'Point Of Interest', desc:'This location is where tallahase is.' },
    { name:'City',        x:191, y:807, category:'Point Of Interest', desc:'The only city in Delta.' },
    { name:'Farm',        x:486, y:213, category:'Point Of Interest', desc:'Its Farm!.' },
    { name:'Dock',        x:622, y:42,  category:'Point Of Interest', desc:'Great fishing location.' },
    { name:'Radio Tower', x:777, y:966, category:'Point Of Interest', desc:'Radio tower in middle of nowhere.' },

    { name:'Teddybear Spawn', x:477, y:197, category:'Spoilers', desc:'Check the loft of the barn.' },
    { name:'Birb',            x:640, y:384, category:'Spoilers', desc:'Look under swansons bed you can see Birb.' },

    { name:'Secret Stash', x:526, y:253, category:'Secret Stashes', desc:'Look behind the farm house.' },
    { name:'Secret Stash', x:550, y:139, category:'Secret Stashes', desc:'Located right next to a tree.' },
    { name:'Secret Stash', x:791, y:186, category:'Secret Stashes', desc:'Look behind Elizabeths.' },
    { name:'Secret Stash', x:541, y:298, category:'Secret Stashes', desc:'Located right next to a tree.' },
    { name:'Secret Stash', x:783, y:387, category:'Secret Stashes', desc:'Located right next to the sandbags.' },
    { name:'Secret Stash', x:946, y:554, category:'Secret Stashes', desc:'Located right next to a tree.' },
    { name:'Secret Stash', x:864, y:475, category:'Secret Stashes', desc:'Located right next to a tree.' },
    { name:'Secret Stash', x:600, y:580, category:'Secret Stashes', desc:'Located right next to a tree.' }
  ];

  const markersUnderground = [
    { name:'Bunker Delta Layout', x:850, y:565, category:'Bunker Layouts', desc:'Unopenable For Now?.' }
  ];

  // Example quest pins — edit/add your real ones
  const markersQuests = [
    { name:'Quest: Example', x:622, y:42, category:'Quest', desc:'Write quest steps here.' }
  ];

  /* ==================== MAP CORE ==================== */

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -6,
    maxZoom: 6,
    zoomSnap: 0.25,
    zoomDelta: 0.25,
    zoomControl: true
  });

  const bounds = new L.LatLngBounds(
    map.unproject([0, IMAGE_HEIGHT], 0),
    map.unproject([IMAGE_WIDTH, 0], 0)
  );

  const overlaySurface     = L.imageOverlay(SURFACE_IMAGE_URL, bounds);
  const overlayUnderground = L.imageOverlay(UNDERGROUND_IMAGE_URL, bounds);
  const overlayQuests      = L.imageOverlay(QUESTS_IMAGE_URL, bounds);

  overlaySurface.addTo(map);

  map.setMaxBounds(bounds);
  map.options.maxBoundsViscosity = 1.0;

  map.fitBounds(bounds, { padding: [90, 90] });
  const startLatLng = map.unproject([START.x, START.y], 0);
  const minZoomToShowAll = map.getBoundsZoom(bounds, true);
  map.options.minZoom = minZoomToShowAll;

  L.control.scale({ metric:true, imperial:false }).addTo(map);

  const xyToLatLng = (x,y) => map.unproject([x,y], 0);
  const filterPanel = document.getElementById('filterPanel');
  const legendPanel = document.getElementById('legendPanel');

  let currentMode = 'surface';
  let byCat = {};

  function clearMarkers() {
    Object.values(byCat).forEach(g => g.clearLayers());
    byCat = {};
  }

  function buildFilters(categories) {
    filterPanel.innerHTML =
      `<h4>Key</h4>
       <div class="mode-row">
         <label><input type="radio" name="mapMode" value="surface" ${currentMode==='surface'?'checked':''}> Surface</label>
         <label><input type="radio" name="mapMode" value="underground" ${currentMode==='underground'?'checked':''}> Underground</label>
         <label><input type="radio" name="mapMode" value="quests" ${currentMode==='quests'?'checked':''}> Quests</label>
       </div>`;

    filterPanel.querySelectorAll('input[name="mapMode"]').forEach(r => {
      r.addEventListener('change', e => setMode(e.target.value));
    });

    categories.sort().forEach(cat => {
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox"> ${cat}`;
      const input = label.querySelector('input');
      input.addEventListener('change', e => {
        if (e.target.checked) byCat[cat].addTo(map);
        else map.removeLayer(byCat[cat]);
      });
      filterPanel.appendChild(label);
    });
  }

  function buildLegend(categories) {
    legendPanel.innerHTML = categories.map(cat => {
      const ico = (categoryIconMap[cat] || {}).iconUrl;
      return `<div>${ico ? `<img src="${ico}" style="width:14px;height:22px;vertical-align:middle;margin-right:6px">` : ''}${cat}</div>`;
    }).join('');
  }

  function renderMarkers(markerData) {
    clearMarkers();
    const categoriesPresent = new Set();

    markerData.forEach(m => {
      categoriesPresent.add(m.category);
      if (!byCat[m.category]) byCat[m.category] = L.layerGroup();

      const html =
        `<b>${m.name || 'Point'}</b>` +
        (m.descHtml ? `<br>${m.descHtml}` : (m.desc ? `<br>${m.desc}` : ''));

      const latlng = xyToLatLng(m.x, m.y);

      const iconDef = categoryIconMap[m.category];
      const mk = iconDef
        ? L.marker(latlng, { icon: L.icon(iconDef) }).bindPopup(html)
        : L.marker(latlng).bindPopup(html);

      byCat[m.category].addLayer(mk);
    });

    buildFilters([...categoriesPresent]);
    buildLegend([...categoriesPresent]);
  }

  function setMode(mode) {
    if (mode === currentMode) return;
    currentMode = mode;

    map.removeLayer(overlaySurface);
    map.removeLayer(overlayUnderground);
    map.removeLayer(overlayQuests);

    if (mode === 'surface') {
      overlaySurface.addTo(map);
      renderMarkers(markersSurface);
    } else if (mode === 'underground') {
      overlayUnderground.addTo(map);
      renderMarkers(markersUnderground);
    } else {
      overlayQuests.addTo(map);
      renderMarkers(markersQuests);
    }

    map.setView(startLatLng, Math.max(map.getZoom(), minZoomToShowAll));
  }

  function controlButton(text, title, onClick) {
    return L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function () {
        const div = L.DomUtil.create('div', 'leaflet-control custom-btn');
        const a = L.DomUtil.create('a', '', div);
        a.href = '#'; a.title = title || text; a.textContent = text;
        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.on(a, 'click', e => { L.DomEvent.preventDefault(e); onClick(); });
        return div;
      }
    });
  }

  map.addControl(new (controlButton('← Maps','Back to maps', () => { window.location.href = 'maps.html'; }))());
  map.addControl(new (controlButton('Home','Reset view', () => map.setView(startLatLng, minZoomToShowAll)))());
  map.addControl(new (controlButton('Fullscreen','Toggle fullscreen', () => {
    const el = document.getElementById('map');
    if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
  }))());

  // Click-to-copy coords (pixel coords)
  const coordsOut = document.getElementById('coordsOut');
  map.on('click', e => {
    const p = map.project(e.latlng, 0);
    const x = Math.round(p.x), y = Math.round(p.y);
    const text = `${x}, ${y}`;
    coordsOut.textContent = text;
    try { navigator.clipboard?.writeText?.(text); } catch {}
    L.popup().setLatLng(e.latlng).setContent(`x,y = <b>${x}, ${y}</b><br>(copied)`).openOn(map);
  });

  // Initial
  renderMarkers(markersSurface);

  // WIP modal
  (function setupWipModal(){
    const modal = document.getElementById('wipModal');
    const btnOk = document.getElementById('wipOk');
    const btnX  = modal.querySelector('.close-x');
    function close() { modal.style.display = 'none'; }
    btnOk.addEventListener('click', close);
    btnX.addEventListener('click', close);
  })();

  // ✅ LAST THING — Leaflet full-size / mobile fix
  (function ensureLeafletFullSize(){
    const refreshMap = () => {
      setTimeout(() => {
        map.invalidateSize(true);
        map.fitBounds(bounds, { animate:false, padding:[90,90] }); // match your padding
      }, 80);
    };

    window.addEventListener('load', refreshMap, { passive:true });
    window.addEventListener('resize', refreshMap, { passive:true });
    window.addEventListener('orientationchange', refreshMap, { passive:true });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) refreshMap();
    });

    refreshMap();
  })();
  </script>
</body>
</html>


